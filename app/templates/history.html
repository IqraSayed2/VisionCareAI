{% extends "base.html" %} {% block title %}History{% endblock %} {% block
content %}

<div class="container" style="margin-top: 3rem;">
  <!-- Header -->
  <div class="history-header">
    <h1 class="history-title">Analysis History</h1>
    <p class="history-subtitle">
      View and manage all your previous eye health screenings.
    </p>
  </div>

  <!-- Stats Cards -->
  <div class="history-stats">
    <div class="history-stat-card">
      <div class="history-stat-icon history-stat-icon-blue">
        <i class="bi bi-file-medical"></i>
      </div>
      <div class="history-stat-content">
        <h3>{{ total_scans }}</h3>
        <p>Total Scans</p>
      </div>
    </div>

    <div class="history-stat-card">
      <div class="history-stat-icon history-stat-icon-green">
        <i class="bi bi-check-circle"></i>
      </div>
      <div class="history-stat-content">
        <h3>{{ normal_results }}</h3>
        <p>Normal Results</p>
      </div>
    </div>

    <div class="history-stat-card">
      <div class="history-stat-icon history-stat-icon-purple">
        <i class="bi bi-clock-history"></i>
      </div>
      <div class="history-stat-content">
        <h3>{{ last_7_days }}</h3>
        <p>Last 7 Days</p>
      </div>
    </div>
  </div>

  {% if detections %}

  <!-- History Table -->
  <div class="history-table-container">
    <table class="history-table">
      <thead>
        <tr>
          <th>Scan Details</th>
          <th>Date</th>
          <th>Diagnosis</th>
          <th>Status</th>
          <th>Confidence</th>
          <th>Actions</th>
        </tr>
      </thead>

      <tbody>
        {% for d in detections %}
        <tr>
          <td>
            <div class="history-scan-cell">
              <img
                src="{{ url_for('static', filename=d.image) }}"
                class="history-scan-thumb"
              />
              <div class="history-scan-info">
                <h4>Retinal Scan #{{ d.id }}</h4>
                <p>Fundus Image</p>
              </div>
            </div>
          </td>

          <td>
            <div style="font-weight: 500">
              {{ d.created_at.strftime('%b %d, %Y') }}
            </div>
            <div style="font-size: 0.75rem; color: #999">
              {{ d.created_at.strftime('%I:%M %p') }}
            </div>
          </td>

          <td>{{ d.disease }}</td>

          <td>
            <span class="history-status history-status-{{ d.status|lower }}">
              <span class="history-status-dot"></span>
              {{ d.status }}
            </span>
          </td>

          <td class="history-confidence">{{ d.confidence }}%</td>

          <td>
            <div class="history-actions">
              <a
                href="#"
                class="history-action-btn"
                title="View Results"
                onclick="viewResult({{ d.id }})"
              >
                <i class="bi bi-eye"></i>
              </a>
              <a
                href="#"
                class="history-action-btn"
                title="Export Report"
                onclick="exportResult({{ d.id }})"
              >
                <i class="bi bi-download"></i>
              </a>
              <a
                href="#"
                class="history-action-btn history-action-btn-danger"
                title="Delete"
                onclick="deleteResult({{ d.id }})"
              >
                <i class="bi bi-trash"></i>
              </a>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% else %}

  <!-- Empty State -->
  <div class="history-empty">
    <div class="history-empty-icon">
      <i class="bi bi-folder-x"></i>
    </div>
    <h3>No Analysis Yet</h3>
    <p>Upload your first retinal scan to see results here.</p>
    <a href="{{ url_for('main.detect') }}" class="history-empty-btn">
      <i class="bi bi-upload"></i> Start Detection
    </a>
  </div>

  {% endif %}
</div>

<script>
function viewResult(id) {
  // Redirect to a result detail page or show modal
  window.location.href = `/result/${id}`;
}

function exportResult(id) {
  // Trigger download of PDF report
  window.open(`/export/${id}`, '_blank');
}

function deleteResult(id) {
  if (confirm('Are you sure you want to delete this scan result? This action cannot be undone.')) {
    fetch(`/delete/${id}`, {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json',
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        location.reload();
      } else {
        alert('Error deleting result: ' + data.message);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Error deleting result');
    });
  }
}
</script>

{% endblock %}
